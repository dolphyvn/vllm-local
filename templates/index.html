<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Financial Assistant</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>Financial AI</span>
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <div class="sidebar-content">
                <!-- System Status -->
                <div class="status-card">
                    <div class="status-header">
                        <i class="fas fa-server"></i>
                        <span>System Status</span>
                    </div>
                    <div class="status-content">
                        <div class="status-item">
                            <span class="status-label">Model:</span>
                            <select class="status-value model-dropdown" id="modelDropdown">
                                <option value="">Loading models...</option>
                            </select>
                            <button class="model-switch-btn" id="modelSwitchBtn" title="Switch Model">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Memory:</span>
                            <span class="status-value" id="memoryStatus">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">API:</span>
                            <span class="status-value online" id="apiStatus">Online</span>
                        </div>
                    </div>
                </div>

                <!-- Memory Management -->
                <div class="memory-section">
                    <div class="section-header">
                        <i class="fas fa-brain"></i>
                        <span>Memory Management</span>
                    </div>
                    <div class="memory-form">
                        <input type="text" id="memoryKey" placeholder="Key (e.g., trading_rule)">
                        <textarea id="memoryValue" placeholder="Value (e.g., Never risk more than 2% per trade)"></textarea>
                        <select id="memoryCategory">
                            <option value="general">General</option>
                            <option value="trading">Trading</option>
                            <option value="strategy">Strategy</option>
                            <option value="risk">Risk Management</option>
                        </select>
                        <button id="storeMemoryBtn" class="store-memory-btn">
                            <i class="fas fa-save"></i>
                            Store Memory
                        </button>
                    </div>
                </div>

                <!-- Recent Memories -->
                <div class="recent-memories">
                    <div class="section-header">
                        <i class="fas fa-history"></i>
                        <span>Recent Memories</span>
                        <button id="refreshMemoriesBtn" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="memories-list" id="memoriesList">
                        <div class="loading">Loading memories...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-info">
                    <h1>Local Financial Assistant</h1>
                    <p>Specialized in forex, gold, and macro analysis</p>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="settings-btn" id="settingsBtn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2>Welcome to your Financial Assistant</h2>
                    <p>I can help you with market analysis, trading strategies, risk management, and more. Ask me anything about financial markets!</p>

                    <div class="example-prompts">
                        <div class="prompt-example" onclick="sendPrompt('Analyze the current gold market trends')">
                            <i class="fas fa-search"></i>
                            <span>Analyze the current gold market trends</span>
                        </div>
                        <div class="prompt-example" onclick="sendPrompt('What are the key risk management principles?')">
                            <i class="fas fa-shield-alt"></i>
                            <span>What are the key risk management principles?</span>
                        </div>
                        <div class="prompt-example" onclick="sendPrompt('Explain forex correlation analysis')">
                            <i class="fas fa-link"></i>
                            <span>Explain forex correlation analysis</span>
                        </div>
                        <div class="prompt-example" onclick="sendPrompt('Best technical indicators for day trading')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Best technical indicators for day trading</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Analysis Shortcuts -->
            <div class="trading-shortcuts" id="tradingShortcuts">
                <div class="shortcuts-header">
                    <i class="fas fa-chart-line"></i>
                    <span>Trading Analysis</span>
                    <button class="toggle-shortcuts" id="toggleShortcuts">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="shortcuts-content" id="shortcutsContent">
                    <div class="shortcut-group">
                        <span class="group-label">Quick Analysis:</span>
                        <button class="shortcut-btn" onclick="sendTradingCommand('analyze current market')">
                            üìä Current Market
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('analyze XAUUSD technical indicators')">
                            üìà Technical Analysis
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('detect trading patterns')">
                            üîç Pattern Detection
                        </button>
                    </div>
                    <div class="shortcut-group">
                        <span class="group-label">Trade Ideas:</span>
                        <button class="shortcut-btn" onclick="sendTradingCommand('Should I buy or sell XAUUSD right now?')">
                            üí° Buy/Sell Signal
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('What are the key support and resistance levels for gold?')">
                            üìè Key Levels
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('Analyze risk/reward for current setup')">
                            ‚öñÔ∏è Risk Analysis
                        </button>
                    </div>
                    <div class="shortcut-group">
                        <span class="group-label">Live Data:</span>
                        <button class="shortcut-btn" onclick="showFileSelection()">
                            üîÑ Live Analysis
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('check market sentiment')">
                            üí≠ Market Sentiment
                        </button>
                        <button class="shortcut-btn" onclick="sendTradingCommand('analyze recent price action')">
                            üìä Price Action
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <div class="input-content">
                        <!-- File Selection for Live Analysis -->
                        <div id="fileSelectionArea" style="display: none; margin-bottom: 8px;">
                            <select id="fileSelect" class="form-control" style="width: 100%; margin-bottom: 8px;">
                                <option value="">Loading 200-candle files...</option>
                            </select>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button id="convertToJsonBtn" class="btn btn-sm btn-primary" style="padding: 6px 12px; flex: 1;" onclick="convertAndSendToChat()">
                                    üîÑ Multi-Timeframe Analysis
                                </button>
                                <button id="cancelFileSelectionBtn" class="btn btn-sm btn-secondary" style="padding: 6px 12px;" onclick="hideFileSelection()">
                                    Cancel
                                </button>
                            </div>
                            <div id="conversionStatus" style="display: none; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
                                <span id="conversionStatusText">Converting...</span>
                            </div>
                        </div>

                        <textarea
                            id="messageInput"
                            placeholder="Ask about market analysis, trading strategies, risk management..."
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button id="fileUploadBtn" class="file-upload-btn" title="Upload file or image">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button id="sendBtn" class="send-btn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- File Upload Area -->
                <div class="file-upload-area" id="fileUploadArea" style="display: none;">
                    <div class="file-preview-container" id="filePreviewContainer">
                        <!-- File previews will be added here -->
                    </div>
                </div>

                <!-- Hidden file input -->
                <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.csv,.doc,.docx,.xls,.xlsx" multiple style="display: none;">

                <div class="input-info">
                    <span class="char-count"><span id="charCount">0</span> / 4000</span>
                    <span class="file-info" id="fileInfo" style="display: none;">
                        <i class="fas fa-paperclip"></i>
                        <span id="fileCount">0</span> file(s) attached
                    </span>
                    <span class="model-info">Powered by Phi-3 Mini</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Processing...</span>
        </div>
    </div>

  
    <script src="/static/js/app.js"></script>
    <script>
        // Simplified Live Analysis Functions
        let files200 = [];

        async function showFileSelection() {
            const fileArea = document.getElementById('fileSelectionArea');
            const inputArea = document.querySelector('.input-content');

            // Load 200-candle files
            await load200CandleFiles();

            // Show file selection area
            fileArea.style.display = 'block';

            // Focus on file select
            document.getElementById('fileSelect').focus();
        }

        async function load200CandleFiles() {
            try {
                const sessionToken = localStorage.getItem('session_token');
                const response = await fetch('/api/available-files', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Filter only files ending with _200.csv
                    files200 = data.files.filter(file => file.name.endsWith('_200.csv'));
                    populate200FileSelect();
                } else {
                    console.error('Failed to load files');
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function populate200FileSelect() {
            const select = document.getElementById('fileSelect');
            select.innerHTML = '';

            if (files200.length === 0) {
                select.innerHTML = '<option value="">No 200-candle files found</option>';
                return;
            }

            // Add "Select file..." as first option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a 200-candle file...';
            select.appendChild(defaultOption);

            files200.forEach(file => {
                const option = document.createElement('option');
                option.value = file.path;
                option.textContent = `${file.name} (${formatFileSize(file.size)})`;
                select.appendChild(option);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function hideFileSelection() {
            const fileArea = document.getElementById('fileSelectionArea');
            fileArea.style.display = 'none';
        }

        // Convert CSV to JSON and send to chat
        async function convertAndSendToChat() {
            const filePath = document.getElementById('fileSelect').value;

            if (!filePath) {
                alert('Please select a file first');
                return;
            }

            const statusDiv = document.getElementById('conversionStatus');
            const statusText = document.getElementById('conversionStatusText');
            const convertBtn = document.getElementById('convertToJsonBtn');
            const cancelBtn = document.getElementById('cancelFileSelectionBtn');

            // Show status and disable buttons
            statusDiv.style.display = 'block';
            statusText.textContent = 'üîÑ Processing multi-timeframe analysis...';
            convertBtn.disabled = true;
            cancelBtn.disabled = true;

            try {
                const sessionToken = localStorage.getItem('session_token');
                const response = await fetch('/api/enhanced-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        file_path: filePath,
                        save_rag: true
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    statusText.textContent = '‚úÖ Multi-timeframe analysis completed! Sending to chat...';

                    console.log('Enhanced analysis result:', result); // Debug log

                    // Create comprehensive chat message with the full JSON data
                    const fileName = result.file_info.filename;
                    const ragData = result.rag_data || {};

                    // Build message with comprehensive multi-timeframe analysis
                    const symbol = result.file_info.symbol;
                    const comprehensiveAnalysis = result.comprehensive_analysis;
                    const marketContext = comprehensiveAnalysis.overall_market_context;
                    const timeframeAnalysis = comprehensiveAnalysis.timeframe_analysis;

                    console.log('Comprehensive analysis loaded:', {
                        symbol: symbol,
                        timeframes: Object.keys(timeframeAnalysis),
                        coverageDays: marketContext.time_coverage_days
                    });

                    let chatMessage = `üîÑ Comprehensive Multi-Timeframe Analysis\n\nüìä Symbol: ${symbol}\nüìà Analysis Type: Multi-Timeframe (All Timeframes)\nüìä Total Timeframes: ${marketContext.total_timeframes_analyzed}\nüïê Time Coverage: ${marketContext.time_coverage_days.toFixed(1)} days\n‚è∞ Analysis Timestamp: ${comprehensiveAnalysis.analysis_timestamp}\n\n**Market Overview:**\n‚Ä¢ Overall Trend: ${marketContext.overall_trend.toUpperCase()}\n‚Ä¢ Trend Consensus: ${JSON.stringify(marketContext.trend_votes)}\n‚Ä¢ Total Time Coverage: ${marketContext.time_coverage_days.toFixed(1)} days\n‚Ä¢ Consensus VWAP: $${marketContext.consensus_levels.avg_vwap?.toFixed(2) || 'N/A'}\n‚Ä¢ Consensus POC: $${marketContext.consensus_levels.avg_poc?.toFixed(2) || 'N/A'}\n‚Ä¢ VWAP Confluence: ${marketContext.consensus_levels.vwap_confluence ? 'YES' : 'NO'}\n‚Ä¢ POC Confluence: ${marketContext.consensus_levels.poc_confluence ? 'YES' : 'NO'}\n\n**Complete Technical Analysis Data:**\n\`\`\`json\n${JSON.stringify(comprehensiveAnalysis, null, 2)}\n\`\`\`\n\n---\n*‚úÖ Comprehensive analysis completed with ${marketContext.total_timeframes_analyzed} timeframes covering ${marketContext.time_coverage_days.toFixed(1)} days of market data*\n\n**Available Timeframes:**\n${Object.keys(timeframeAnalysis).map(tf => `‚Ä¢ ${tf}: ${timeframeAnalysis[tf].analyzed_candles} candles, ${timeframeAnalysis[tf].time_coverage_hours.toFixed(1)} hours coverage`).join('\\n')}\n\nYou are an expert trader, technical analysis, data analysis. Please tell me best trade direction, included clear entry, stoploss and take profit.`;

                    console.log('Final chat message length:', chatMessage.length); // Debug log

                    // Hide file selection area
                    hideFileSelection();

                    // Add to chat using existing app function
                    if (window.app && window.app.sendMessage) {
                        // Set the message in the input
                        document.getElementById('messageInput').value = chatMessage;

                        // Enable send button
                        document.getElementById('sendBtn').disabled = false;

                        // Send the message
                        setTimeout(() => {
                            window.app.sendMessage();
                        }, 500);
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                statusText.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.style.background = 'rgba(207, 34, 46, 0.1)';
                statusDiv.style.color = 'var(--error)';
            } finally {
                // Re-enable buttons
                convertBtn.disabled = false;
                cancelBtn.disabled = false;

                // Hide status after 3 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    statusDiv.style.background = '';
                    statusDiv.style.color = '';
                }, 3000);
            }
        }

        // Event listener for file selection
        document.addEventListener('DOMContentLoaded', function() {
            const fileSelect = document.getElementById('fileSelect');
            if (fileSelect) {
                fileSelect.addEventListener('change', function() {
                    if (this.value) {
                        // Auto-enable convert button when file is selected
                        document.getElementById('convertToJsonBtn').disabled = false;
                    } else {
                        document.getElementById('convertToJsonBtn').disabled = true;
                    }
                });
            }
        });

        // Fallback authentication check in case app.js doesn't load properly
        window.addEventListener('load', async function() {
            // Check if already authenticated by app.js
            if (window.app && window.app.isAuthenticated) {
                return;
            }

            // Manual authentication check
            const sessionToken = localStorage.getItem('session_token');
            if (sessionToken) {
                try {
                    const response = await fetch('/auth/status', {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    const data = await response.json();

                    if (data.authenticated) {
                        // Token is valid, initialize app
                        console.log('Authentication verified via fallback check');
                        return;
                    } else {
                        // Token invalid, redirect to login
                        localStorage.removeItem('session_token');
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Authentication check failed:', error);
                    window.location.href = '/login';
                }
            } else {
                // No token found, redirect to login
                window.location.href = '/login';
            }
        });
    </script>
</body>
</html>